{{- $s := .Site.Params -}}

{{/* Site info */}}
{{- $siteName := .Site.Title -}}
{{- $siteURL := .Site.BaseURL -}}
{{- $siteLang := .Site.LanguageCode | default "en-us" -}}
{{- $siteAuthor := .Site.Data.authors.default.name -}}
{{- $siteAuthorImage := .Site.Data.authors.default.image | absURL -}}
{{- $siteAuthorEmail := .Site.Data.authors.default.email -}}
{{- $siteAuthorTwitter := .Site.Data.authors.default.twitter -}}
{{- $siteURL := .Site.BaseURL -}}
{{- $siteLogo := $s.Logo | absURL -}}
{{- $siteFeedLogo := $s.feedLogo | absURL -}}
{{- $siteFeedIcon := $s.feedIcon | absURL -}}
{{- $siteDesc := $s.description -}}
{{- $siteLicense := T "license" -}}
{{- $siteCopyright := T "all_rights" -}}

{{/* Determine pages to include */}}
{{- $pages := (where .RegularPages "Type" "in" site.Params.mainSections) -}}
{{- if (eq .Kind "home") -}}
  {{- $pages = (where site.RegularPages "Type" "in" site.Params.mainSections) -}}
{{- end -}}
{{- $pages = where $pages ".Params.disable_feed" "!=" true -}}
{{- $pages = where $pages ".Params.unlisted" "!=" true -}}
{{- $limit := .Site.Config.Services.RSS.Limit -}}
{{- if ge $limit 1 -}}
{{- $pages = $pages | first $limit -}}
{{- end -}}

{{- printf "<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"yes\"?>" | safeHTML }}
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xml:base="{{ $siteURL }}" xml:lang="{{ $siteLang }}">
  <channel>
    <title>{{ $siteName }}</title>
    <link>{{ $siteURL }}</link>
    {{- with $siteDesc }}
    <description>{{ . }}</description>
    {{- end }}
    {{- with $siteFeedLogo }}
    <image>
      <url>{{ . }}</url>
      <title>{{ $siteName }}</title>
      <link>{{ $siteURL }}</link>
    </image>
    {{- end }}
    <generator>Hugo - gohugo.io</generator>
    {{- with $siteLang }}
    <language>{{ . }}</language>
    {{- end }}
    {{- with $siteAuthorEmail }}
    <managingEditor>{{ . }}{{ with $siteAuthor }} ({{ . }}){{end }}</managingEditor>
    {{- end }}
    {{- with $siteAuthorEmail }}
    <webMaster>{{ . }}{{ with $siteAuthor }} ({{ . }}){{ end }}</webMaster>
    {{- end }}
    <copyright>
      {{- T "copyright" | markdownify }}
      {{- with $s.since }} {{ . }}&#8211;{{ end }}{{ now.Format "2006"}}, {{ $siteName }}. {{ T "all_rights" | markdownify -}}
    </copyright>
    {{- if not .Date.IsZero }}
    <lastBuildDate>{{ now.Format "Mon, 02 Jan 2006 15:04:05 -0700" | safeHTML }}</lastBuildDate>
    {{- end }}
    {{- with .OutputFormats.Get "RSS" -}}
    {{ printf "<atom:link href=%q rel=\"self\" type=%q />" .Permalink .MediaType | safeHTML }}
    {{- end -}}

    {{- range $pages -}}
    {{- $p := .Params -}}
    {{/* Post permalink */}}
    {{- $relpath := "" -}}
    {{- if or $s.usePageBundles $p.usePageBundles -}}
      {{- $relpath = .Page.RelPermalink -}}
    {{- end -}}
    {{ if eq $p.usePageBundles false -}}
      {{- $relpath = "" -}}
    {{ end -}}
    {{- $permalink := .Permalink -}}

    {{/* Post title */}}
    {{- $title := .Title -}}

    {{/* Post date */}}
    {{- $date := .Date -}}
    {{- $updated := .Lastmod -}}
    {{- if eq $date $updated -}}
      {{- $updated = "" -}}
    {{- end -}}

    {{/* Post summary */}}
    {{- $summary := truncate 200 .Summary -}}
    {{- with $p.description -}}
      {{- $summary = truncate 200 . -}}
    {{- end -}}
    {{- if .IsHome -}}
      {{- $summary = $s.description -}}
      {{- with $p.description -}}
        {{- $summary = . -}}
      {{- end -}}
    {{- end -}}

    {{/* Post byline */}}
    {{- $author := $siteAuthor -}}
    {{- $authorName := $siteAuthor -}}
    {{- $authorImage := $siteAuthorImage -}}
    {{- $authorEmail := $siteAuthorEmail -}}
    {{- $authorTwitter := $siteAuthorTwitter -}}
    {{- with $p.author -}}
      {{- $author = index $.Site.Data.authors . -}}
      {{- $authorName = $author.name -}}
      {{- $authorImage = $author.image | absURL -}}
      {{- $authorEmail = $author.email -}}
      {{- $authorTwitter = $author.twitter -}}
    {{- end -}}

    {{/* Post images */}}
    {{- $image := absURL $s.fallBackOgImage -}}
    {{- with $p.featureImage -}}
      {{- $fullpath := ( add $relpath . ) -}}
      {{- $image = absURL $fullpath -}}
    {{- end -}}
    {{- with $p.thumbnail -}}
      {{- $fullpath := ( add $relpath . ) -}}
      {{- $image = absURL $fullpath -}}
    {{- end -}}
    {{- with $p.shareImage -}}
      {{- $fullpath := ( add $relpath . ) -}}
      {{- $image = absURL $fullpath -}}
    {{- end -}}

    {{/* Post keywords */}}
    {{- $metaKeywords := slice -}}
    {{- with $p.categories -}}
      {{- $metaKeywords = $metaKeywords | append . -}}
    {{- end -}}
    {{- with $p.tags -}}
      {{- $metaKeywords = $metaKeywords | append . -}}
    {{- end -}}
    {{- with $p.keywords -}}
      {{- $metaKeywords = $metaKeywords | append . -}}
    {{- end -}}
    {{- with $metaKeywords -}}
      {{/* Add meta keywords based on tags and categories. */}}
      {{- range $key, $value := $.Site.Data.terms.keywords.additional -}}
        {{- if in $metaKeywords $key -}}
          {{- $metaKeywords = $metaKeywords | append $value -}}
        {{- end -}}
      {{- end -}}
      {{- $metaKeywords = delimit $metaKeywords ", " -}}
    {{- end -}}
    {{- $keywords := "" -}}
    {{- with $.Site.Data.terms.keywords.default -}}
      {{- $keywords = delimit $.Site.Data.terms.keywords.default "," -}}
    {{- end -}}
    {{- with $metaKeywords -}}
      {{- $keywords = $metaKeywords -}}
    {{- end -}}
    <item>
      <title>{{ $title }}</title>
      <link>{{ $permalink }}</link>
      <pubDate>{{ $date.Format "Mon, 02 Jan 2006 15:04:05 -0700" | safeHTML }}</pubDate>
      {{- with $authorEmail }}
      <author>{{ . }}{{ with $authorName }} ({{.}}){{end}}</author>
      {{- end }}
      <guid>{{ $permalink }}</guid>
      {{ $content := trim .Content "\n" -}}
      {{- $content = replace $content "\n" " " -}}
      <description>{{ $content | html }}</description>
    </item>
    {{ end }}
  </channel>
</rss>
