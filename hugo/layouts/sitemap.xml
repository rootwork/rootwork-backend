{{- $s := .Site.Params -}}
{{/* Determine pages to include */}}
{{- $pages := .Site.Pages -}}
{{- $pages = where $pages ".Params.disable_feed" "!=" true -}}
{{- $pages = where $pages ".Params.unlisted" "!=" true -}}

{{ printf "<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"yes\"?>" | safeHTML }}

<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
  xmlns:xhtml="http://www.w3.org/1999/xhtml">
  {{ range $pages }}
    {{- $date := partial "function/vars/getDate" . -}}
    {{- $listingDate := "" -}}
    {{- $listingYM := "" -}}
    {{- if $date.published -}}
      {{- if $date.updated -}}
        {{- $listingDate = $date.updatedTime -}}
        {{- $listingYM = dateFormat "2006-01" $date.updated -}}
      {{- else -}}
        {{- $listingDate = $date.publishedTime -}}
        {{- $listingYM = dateFormat "2006-01" $date.published -}}
      {{- end -}}
    {{- end }}
    {{- if .Permalink -}}
  <url>
    <loc>{{ .Permalink }}</loc>
    <lastmod>{{ $listingDate }}</lastmod>
    {{- with .Params.Priority }}
    <priority>{{ . }}</priority>
    {{- else }}
    {{- if ge .Sitemap.Priority 0.0 }}
    {{- if (eq .Kind "home") -}}
    {{/* 1.0 priority for home page */}}
    <priority>1.0</priority>
    {{- else if eq $listingYM (now.Format "2006-01") -}}
      {{- if eq .Type "blog" -}}
      {{/* 0.9 priority for posts (up)dated this month */}}
    <priority>0.9</priority>
      {{- end -}}
    {{- else if eq $listingYM (now.Format "2006") -}}
      {{- if eq .Type "blog" -}}
      {{/* 0.8 priority for posts (up)dated this year */}}
    <priority>0.8</priority>
      {{- else if ne .Type "blog" -}}
      {{/* 0.7 priority for pages and lists updated this year */}}
    <priority>0.7</priority>
      {{- end -}}
    {{- else if eq .Kind "page" -}}
    {{/* 0.6 priority for all other posts and pages */}}
    <priority>0.6</priority>
    {{- else -}}
    {{/* Default priority (0.5) for lists and everything else */}}
    <priority>{{ .Sitemap.Priority }}</priority>
    {{- end -}}
    {{- end -}}
    {{- end }}
    {{- with .Sitemap.ChangeFreq }}
    <changefreq>{{ . }}</changefreq>
    {{- end }}
    {{- if .IsTranslated }}
    {{- range .Translations }}
    <xhtml:link
      rel="alternate"
      hreflang="{{ .Language.Lang }}"
      href="{{ .Permalink }}"
    />
    {{- end }}
    <xhtml:link
      rel="alternate"
      hreflang="{{ .Language.Lang }}"
      href="{{ .Permalink }}"
    />
    {{- end }}
  </url>
    {{- end -}}
  {{ end }}
</urlset>
