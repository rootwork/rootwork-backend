{{- $s := .Site.Params -}}
{{- $pages := where .Site.RegularPages "Type" "in" .Site.Params.mainSections -}}
{{- $limit := .Site.Config.Services.RSS.Limit -}}
{{- if ge $limit 1 -}}
{{- $pages = $pages | first $limit -}}
{{- end -}}
{{ printf "<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"yes\"?>" | safeHTML }}
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="{{ .Site.LanguageCode }}">
  <title>{{ .Site.Title }}</title>
  {{- with .Site.Params.description }}
  <subtitle>{{ . }}</subtitle>
  {{- end }}
  <id>{{ "/" | absLangURL }}</id>
  <author>
    <name>{{ .Site.Title }}</name>
    <uri>{{ "/" | absLangURL }}</uri>
  </author>
  <generator>Hugo gohugo.io</generator>
  <rights>
    {{- T "copyright" | markdownify }}
    {{- with $s.since }} {{ . }}&#8211;{{ end }}{{ now.Format "2006"}}, {{ .Site.Title }}. {{ T "all_rights" | markdownify -}}
  </rights>
  {{- with .Site.Params.feedIcon }}
  <icon>{{ . | absURL }}</icon>
  {{- end }}
  {{- with .Site.Params.feedLogo }}
  <logo>{{ . | absURL }}</logo>
  {{- end }}
  <updated>{{ dateFormat "2006-01-02T15:04:05Z" now.UTC | safeHTML }}</updated>
  {{- with .OutputFormats.Get "ATOM" }}
  {{ printf `<link rel="self" type="%s" href="%s" hreflang="%s"/>` .MediaType.Type .Permalink $.Site.LanguageCode | safeHTML }}
  {{- end }}
  {{- range .AlternativeOutputFormats }}
  {{ printf `<link rel="alternate" type="%s" href="%s" hreflang="%s"/>` .MediaType.Type .Permalink $.Site.LanguageCode | safeHTML }}
  {{- end }}
  {{- range $pages }}
  <entry>
    <title>{{ .Title }}</title>
    {{- $author := index .Site.Data.authors (.Params.author | default "default") }}
    <author>
      <name>{{ $author.name }}</name>
      <uri>{{ $author.uri }}</uri>
    </author>
    <id>{{ .Permalink }}</id>
    {{- if .IsTranslated -}}
    {{ range .Translations }}
    <link rel="alternate" href="{{ .Permalink }}" hreflang="{{ .Language.Lang }}"/>
    {{- end -}}
    {{ end }}
    {{/* Adding a random number of seconds+millisecs to ensure no two dates are exactly the same. */}}
    {{- $date := .Lastmod.Unix -}}
    {{- $seed := int ( printf "0x%.8s" (md5 (readFile .File.Path))) -}}
    {{- $rnd := mod (add (mul 13 $seed) 97) 400 -}}
    {{- $date = add $date $rnd -}}
    <updated>{{ dateFormat "2006-01-02T15:04:05Z" $date | safeHTML }}</updated>
    <published>{{ dateFormat "2006-01-02T15:04:05Z" .Date.UTC | safeHTML }}</published>
    {{/* In addition to trimming newlines, this helpfully escapes HTML. */}}
    {{- $content := trim .Content "\n" -}}
    {{- $content = replace $content "\n" " " -}}
    {{/* Fix HTML entities that get mangled and invalidate the feed. */}}
    {{- $content = replace $content "é" "&eacute;" -}}
    {{- $content = replace $content "í" "&iacute;" -}}
    {{- $content = replace $content "ï" "&iuml;" -}}
    <content type="html">{{ $content }}</content>
  </entry>
  {{- end }}
</feed>
