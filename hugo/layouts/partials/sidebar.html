{{/* 1. Displaying intro description only if this is not the home page.
  2. Removing auto-generated year and month archives.
  3. Adding class="taxonomy_[[ $key ]]_group"
  4. Changing tag style from "upper" to "humanize" (all caps to initial caps)
*/}}
{{ $s := site.Params }}
<aside class="sidebar">
  <section class="sidebar_inner">
    {{ partial "search/widget" . }}
    {{- $introDescription := $s.introDescription }}
    {{- with .Params.introDescription }}
      {{- $introDescription = . }}
    {{- end }}
    {{- if (ne .IsHome true) }}
      {{- if $introDescription }}
        {{- $author := $s.Author }}
        {{- $showAuthorPhoto := false }}
        {{- $fullAuthor := reflect.IsMap $author }}
        {{- if $fullAuthor }}
          {{- if $author.photo }}
            {{- $showAuthorPhoto = true }}
          {{- end }}
        {{- end }}
        {{- if $showAuthorPhoto }}
          <div class="author_header">
            <img
              width="48"
              height="48"
              src="{{ absURL $author.sm_photo }}"
              alt="{{ $author.name }} photo"
            />
            <h2>{{ $author.name }}</h2>
          </div>
        {{- else }}
          <h2>
            {{ if $fullAuthor }}
              {{ $author.name }}
            {{ else }}
              {{ $author }}
            {{ end }}
          </h2>
        {{- end }}
        <div class="author_bio">
          {{ markdownify $introDescription }}
        </div>
        {{- if ( ne $s.introURL false ) }}
          {{- $r := T "read_more" }}
          <a
            href="{{ absLangURL (default "about/" $s.introURL) }}"
            class="button mt-1"
            role="button"
            title="{{ $r }} about me"
            >{{ $r }}<span class="hidden-visually"> about me</span></a
          >
        {{- end }}
      {{- end }}
    {{- end }}

    {{ if .Site.Params.sidebardisclaimer }}
      <div class="sidebardisclaimer">
        <h2 class="mt-4">Disclaimer</h2>
        {{ .Site.Params.disclaimerText }}
      </div>
    {{ end }}

    {{- $relatedInSidebar := true }}
    {{- if eq $s.showRelatedInSidebar false }}
      {{ $relatedInSidebar = false }}
    {{- end }}
    {{ if (and ($relatedInSidebar) (isset .Params "series") ) }}
      {{ $related := where .Site.RegularPages ".Params.series" "eq" .Params.series }}
      <h2 class="mt-4">{{ T "series_posts" }}</h2>
      <ul>
        {{ range $related }}
          <li>
            <a href="{{ .Permalink }}" class="nav-link"
              >{{ .Title | markdownify }}</a
            >
            >
          </li>
        {{ end }}
      </ul>
    {{ end }}

    {{- $posts := where (where .Site.RegularPages "Permalink" "!=" .Permalink) "Type" "in" $s.mainSections }}
    {{- $featured := default 8 $s.numberOfFeaturedPosts }}
    {{- with first $featured (where $posts "Params.featured" true) }}
      <h2 class="mt-4">{{ T "featured_posts" }}</h2>
      <ul>
        {{- range . }}
          <li>
            <a href="{{ .Permalink }}" class="nav-link"
              >{{ .Title | markdownify }}</a
            >
          </li>
        {{- end }}
      </ul>
    {{- end }}
    <h2 class="mt-4">{{ T "recent_posts" }}</h2>
    <ul class="flex-column">
      {{- $recent := default 8 $s.numberOfRecentPosts }}
      {{- range first $recent $posts }}
        <li>
          <a href="{{ .Permalink }}" class="nav-link"
            >{{ .Title | markdownify }}</a
          >
        </li>
      {{- end }}
    </ul>
    {{- $tagsLimit := (default 100 $s.numberOfTagsShown) }}
    {{- range $key, $value := .Site.Taxonomies }}
      {{- if ( ne $key "year" ) }}
        {{- if ( ne $key "month" ) }}
          {{- if gt $value 0 }}
            <div class="taxonomy_{{ $key }}_group">
              <h2 class="mt-4 taxonomy" id="{{ $key }}-section">
                {{ T $key }}
              </h2>
              <nav class="tags_nav">
                {{- $onPageTags := $.Page.Params.tags }}
                {{- $slicedTags := ($value.ByCount | first $tagsLimit) }}
                {{- range $slicedTags }}
                  <a
                    href="{{ absLangURL $key }}/{{ (replace .Name "#" "%23") | urlize }}/"
                    class="post_tag button button_translucent"
                    title="View all content related to '{{ humanize .Name }}'"
                  >
                    {{ humanize .Name }}
                    <span class="button_tally">{{ .Count }}</span>
                  </a>
                {{ end }}
                {{ if gt (len $value.ByCount) $tagsLimit }}
                  <br />
                  <div class="post_tags_toggle button">
                    {{ T (printf "all_%s" (lower $key)) }}
                  </div>
                  {{- $tagsInfo := newScratch }}
                  <div class="post_tags">
                    <div class="tags_list">
                      {{- range $value.Alphabetical }}
                        {{ $tagsInfo.Add "tagsInfo" (slice .Name .Count) }}
                        <a
                          href="{{ absLangURL $key }}/{{ (replace .Name "#" "%23") | urlize }}/"
                          class="post_tag button button_translucent foo"
                          data-position="{{ .Count }}"
                          title="View all content related to '{{ humanize .Name }}'"
                        >
                          {{- humanize .Name -}}
                          <span class="button_tally">{{ .Count }}</span>
                        </a>
                      {{ end }}
                      <div class="tags_sort">
                        <span title="sort alphabetically">[A~Z]</span
                        ><span title="sort by count">[0~9]</span>
                      </div>
                      <span class="tags_hide"
                        ><svg class="icon">
                          <use xlink:href="#closeme"></use></svg
                      ></span>
                    </div>
                  </div>
                {{- end }}
              </nav>
            </div>
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
  </section>
</aside>
