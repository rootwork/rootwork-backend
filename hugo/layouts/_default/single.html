{{/* 1. Adding microformats for indieweb:
  - article class h-entry
  - h1 class p-name and itemprops
  - post_body e-content and itemprop
  2. Moving featured image to title area to use as background.
  3. Adding optional shaded class to featured image.
  4. Adding featured image credit section at the bottom.
  5. Adding #content anchor to main content (for skip-to link).
  6. Adding automated shortcode at the bottom.
  7. Adding "tree" partial at the bottom.
*/}}
{{- define "main" }}
  {{- $s := .Site.Params }}
  {{- $p := .Params }}
  {{- $scratch := newScratch }}
  {{- if isset $p "image" }}
    {{- $scratch.Set "image" $p.image }}
  {{- else }}
    {{ $scratch.Set "image" $s.fallBackOgImage }}
  {{- end }}
  {{- $image := $scratch.Get "image" }}
  {{- $bg := absLangURL (path.Join "images" $image) }}
  <div
    class="
      {{ if ne $p.singleColumn true }}grid-inverse{{ end }}
      wrap
      content
    "
  >
    <article class="post_content h-entry" id="content">
      {{- $t := .Title }}
      <h1 class="post_title p-name" itemprop="name headline">
        {{- with $p.featureImage -}}
          <div class="post_featured">
            {{- partial "image" (dict "file" $p.featureImage "alt" $p.featureImageAlt "cap" $p.featureImageCap "type" "featured" "Page" $.Page) }}
          </div>
        {{- end -}}
        <span
          class="
          post_title__text
          {{ if eq $p.featureImageShade true -}}
            shaded
          {{- end -}}
        "
        >
          {{ $t | markdownify }}
        </span>
      </h1>
      {{- partial "post-meta" . }}
      {{ if $p.toc }}
        <div class="post_toc">
          <h2>{{ T "overview" }}</h2>
          {{ .TableOfContents }}
        </div>
      {{ end }}
      <div class="post_body e-content" itemprop="articleBody">
        {{- .Content }}
        {{ with $p.featureImageCreditFlickr }}
          <div class="featured_image_credit">
            Top image credit Flickr user
            <a
              href="https://www.flickr.com/photos/{{ . }}"
              title="View this person's Flickr stream"
              >{{ . }}</a
            >.
          </div>
        {{ end }}
        {{ with $p.featureImageCreditCustom }}
          <div class="featured_image_credit">
            {{ . | markdownify }}
          </div>
        {{ end }}
        {{ range $p.aliases }}
          {{ if in . "/p/" }}
            <div class="short_link">
              <strong>Short link:</strong>
              <code><a href="{{ . }}">https://rootwork.org{{ . }}</a></code>
            </div>
          {{ end }}
        {{ end }}
      </div>

      {{- $showRelatedInArticle := true }}
      {{- if eq $s.showRelatedInArticle false }}
        {{- $showRelatedInArticle = false }}
      {{- else if eq $p.showRelatedInArticle false }}
        {{- $showRelatedInArticle = false }}
      {{- end }}
      {{- if ne $showRelatedInArticle false }}
        {{- partial "related" . }}
      {{- end }}

      {{- $showComments := true }}
      {{- if eq $s.comments false }}
        {{- $showComments = false }}
      {{- else if eq $p.comments false }}
        {{- $showComments = false }}
      {{- end }}
      {{- if ne $showComments false }}
        {{- partial "comments" . }}
      {{- end }}
      {{- partial "i18nlist" . }}
      {{- partial "tree" (dict "display" "roots") }}
    </article>
    {{- if ( ne $p.sidebar false ) }}
      {{- partial "sidebar" . }}
    {{ end }}
  </div>
{{- end }}
