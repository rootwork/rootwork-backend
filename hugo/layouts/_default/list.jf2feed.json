{{/*
  For details on the syntax and fields, see:
  https://www.w3.org/TR/jf2/#jf2feed_example
  https://jf2.spec.indieweb.org/#jf2feed_required_fields
*/}}
{{- $s := .Site.Params -}}

{{/* Determine pages to include */}}
{{- $pages := partial "function/getFeedPages" . -}}

{{- $.Scratch.Add "jf2feed" slice -}}
{{- range $pages -}}
  {{- $p := .Params -}}
  {{- with partial "function/getVars" . -}}
    {{- $.Scratch.Add "jf2feed" (dict
      "type" "entry"
      "url" .page.permalink
      "published" .page.date
      "updated" .page.updated
      "name" .page.title
      "summary" (.page.summary | plainify)
      "content" (dict
        "html" .feed.content.html
        "text" .feed.content.plain
      )
      "category" .page.keywords
      "photo" .page.image
      "author" (dict
        "type" "card"
        "url" .site.url
        "name" .author.name
        "photo" .author.image
      )
    ) -}}
  {{- end -}}
{{- end -}}

{{- with partial "function/getVars" . -}}
  {{- $jf2 := (dict
    "type" "feed"
    "url" .site.url
    "name" .site.name
    "children" ($.Scratch.Get "jf2feed")
  ) -}}
  {{- $jf2 | jsonify -}}
{{- end -}}
