{{/*
  For details on the syntax and fields, see:
  https://www.w3.org/TR/jf2/#jf2feed_example
  https://jf2.spec.indieweb.org/#jf2feed_required_fields
*/}}
{{- $s := .Site.Params -}}

{{/* Site info */}}
{{- $siteName := .Site.Title -}}
{{- $siteURL := .Site.BaseURL -}}
{{- $siteLang := .Site.LanguageCode | default "en-us" -}}
{{- $siteAuthor := .Site.Data.authors.default.name -}}
{{- $siteAuthorImage := .Site.Data.authors.default.image | absURL -}}
{{- $siteAuthorEmail := .Site.Data.authors.default.email -}}
{{- $siteAuthorTwitter := .Site.Data.authors.default.twitter -}}
{{- $siteURL := .Site.BaseURL -}}
{{- $siteLogo := $s.Logo | absURL -}}
{{- $siteFeedLogo := $s.feedLogo | absURL -}}
{{- $siteFeedIcon := $s.feedIcon | absURL -}}
{{- $siteDesc := $s.description -}}
{{- $siteLicense := T "license" -}}
{{- $siteCopyright := T "all_rights" -}}

{{/* Determine pages to include */}}
{{- $pages := (where .RegularPages "Type" "in" site.Params.mainSections) -}}
{{- if (eq .Kind "home") -}}
  {{- $pages = (where site.RegularPages "Type" "in" site.Params.mainSections) -}}
{{- end -}}
{{- $pages = where $pages ".Params.disable_feed" "!=" true -}}
{{- $pages = where $pages ".Params.unlisted" "!=" true -}}

{{- $.Scratch.Add "jf2feed" slice -}}
{{- range $pages -}}
  {{- $p := .Params -}}

  {{/* Post permalink */}}
  {{- $relpath := "" -}}
  {{- if or $s.usePageBundles $p.usePageBundles -}}
    {{- $relpath = .Page.RelPermalink -}}
  {{- end -}}
  {{ if eq $p.usePageBundles false -}}
    {{- $relpath = "" -}}
  {{ end -}}
  {{- $permalink := .Permalink -}}

  {{/* Post title */}}
  {{- $title := .Title -}}

  {{/* Post date */}}
  {{- $date := .Date -}}
  {{- $updated := .Lastmod -}}
  {{- if eq $date $updated -}}
    {{- $updated = "" -}}
  {{- end -}}

  {{/* Post summary */}}
  {{- $summary := truncate 200 .Summary -}}
  {{- with $p.description -}}
    {{- $summary = truncate 200 . -}}
  {{- end -}}
  {{- if .IsHome -}}
    {{- $summary = $s.description -}}
    {{- with $p.description -}}
      {{- $summary = . -}}
    {{- end -}}
  {{- end -}}

  {{/* Post byline */}}
  {{- $author := $siteAuthor -}}
  {{- $authorName := $siteAuthor -}}
  {{- $authorImage := $siteAuthorImage -}}
  {{- $authorEmail := $siteAuthorEmail -}}
  {{- $authorTwitter := $siteAuthorTwitter -}}
  {{- with $p.author -}}
    {{- $author = index $.Site.Data.authors . -}}
    {{- $authorName = $author.name -}}
    {{- $authorImage = $author.image | absURL -}}
    {{- $authorEmail = $author.email -}}
    {{- $authorTwitter = $author.twitter -}}
  {{- end -}}

  {{/* Post images */}}
  {{- $image := absURL $s.fallBackOgImage -}}
  {{- with $p.featureImage -}}
    {{- $fullpath := ( add $relpath . ) -}}
    {{- $image = absURL $fullpath -}}
  {{- end -}}
  {{- with $p.shareImage -}}
    {{- $fullpath := ( add $relpath . ) -}}
    {{- $image = absURL $fullpath -}}
  {{- end -}}

  {{/* Post keywords */}}
  {{- $metaKeywords := slice -}}
  {{- with $p.categories -}}
    {{- $metaKeywords = $metaKeywords | append . -}}
  {{- end -}}
  {{- with $p.tags -}}
    {{- $metaKeywords = $metaKeywords | append . -}}
  {{- end -}}
  {{- with $p.keywords -}}
    {{- $metaKeywords = $metaKeywords | append . -}}
  {{- end -}}
  {{- with $metaKeywords -}}
    {{/* Add meta keywords based on tags and categories. */}}
    {{- range $key, $value := $.Site.Data.terms.keywords.additional -}}
      {{- if in $metaKeywords $key -}}
        {{- $metaKeywords = $metaKeywords | append $value -}}
      {{- end -}}
    {{- end -}}
    {{- $metaKeywords = delimit $metaKeywords ", " -}}
  {{- end -}}
  {{- $keywords := "" -}}
  {{- with $.Site.Data.terms.keywords.default -}}
    {{- $keywords = delimit $.Site.Data.terms.keywords.default "," -}}
  {{- end -}}
  {{- with $metaKeywords -}}
    {{- $keywords = $metaKeywords -}}
  {{- end -}}

  {{- $.Scratch.Add "jf2feed" (dict
    "type" "entry"
    "url" $permalink
    "published" .Date
    "updated" $updated
    "name" $title
    "summary" ($summary | plainify)
    "content" (dict
      "html" .Content
      "text" .Plain
    )
    "category" $keywords
    "photo" $image
    "author" (dict
      "type" "card"
      "url" $siteURL
      "name" $authorName
      "photo" $authorImage
    )
  ) -}}
{{- end -}}

{{- $jf2 := (dict
  "type" "feed"
  "url" $siteURL
  "name" $siteName
  "children" ($.Scratch.Get "jf2feed")
) -}}

{{- $jf2 | jsonify -}}
